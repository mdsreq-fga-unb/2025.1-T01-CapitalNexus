{% extends 'members/layout.html' %}
{% load static %}

{% block dashboard_title %}Avaliar Justificativas{% endblock %}
{% block page_title %}Gerenciamento de Presenças{% endblock %}

{% block dashboardcontent %}
    <div class="tabs-nav">
        <a href="{% url 'membros:faltaseadvertencias' %}" class="tab-link">Minhas Presenças</a>
        <a href="{% url 'membros:justificativas' %}" class="tab-link active">Avaliar Justificativas</a>
        <a href="{% url 'membros:advertencias' %}" class="tab-link">Gerenciar Advertências</a>
    </div>
        <form class="filter-bar" method="get">
        <select name="reuniao">
            <option value="">Todas as Reuniões</option>
            {% for reuniao in filtro_reunioes %}
                <option 
                    value="{{ reuniao.id }}" 
                    {% if request.GET.reuniao|add:0 == reuniao.id %}selected{% endif %}>
                    {{ reuniao.titulo }}
                </option>
            {% endfor %}
        </select>

        <select name="status">
            <option value="">Todos os status</option>
            <option value="PENDENTE" {% if request.GET.status == 'PENDENTE' or not request.GET.status %}selected{% endif %}>Pendente</option>
            <option value="ACEITA" {% if request.GET.status == 'ACEITA' %}selected{% endif %}>Aceita</option>
            <option value="REJEITADA" {% if request.GET.status == 'REJEITADA' %}selected{% endif %}>Rejeitada</option>
        </select>
        <a href="{% url 'membros:justificativas' %}"class="botao-cancel">Limpar filtros</a>
        <button type="submit" class="btn-filter">Aplicar filtros</button>
    </form>

    <div class="justificativas-grid">
        {% for just in justificativas %}
        <div class="justificativa-card">
            <div class="card-header">
                <h4>{{ just.falta.membro.nome }}</h4>
                <span class="tag tag-status-{{ just.status_analise }}">{{ just.status_analise}}</span>
            </div>
            <div class="card-body">
                <p><strong>Reunião:</strong> {{ just.falta.reuniao.titulo }}</p>
                <p><strong>Data:</strong> {{ just.falta.reuniao.data_hora|date:"d/m/Y H:i" }}</p>
                <p><strong>Justificativa:</strong> {{ just.texto_justificativa }}</p>
                {% if just.status_analise != 'PENDENTE' %}
                    <p><strong>Feedback da análise:</strong> {{ just.feedback_analise|default:"Nenhum feedback foi cadastrado." }}</p>
                {% endif %}
            </div>
            <div class="card-footer" style="justify-content: flex-end;">
                {% if just.status_analise == 'PENDENTE' %}
                    <a href="#" class="card-button btn-presence" data-target-modal="#avaliar-modal-{{ just.id }}">Avaliar</a>
                {% else %}
                    <p>Já avaliado</p>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="panel"><p>Nenhuma justificativa para avaliação.</p></div>
        {% endfor %}
    </div>

    {% for just in justificativas %}
    <div id="avaliar-modal-{{ just.id }}" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Avaliar Justificativa</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Membro:</strong> {{ just.falta.membro.nome }}</p>
                <p><strong>Reunião:</strong> {{ just.falta.reuniao.titulo }}</p>
                <p><strong>Data:</strong> {{ just.falta.reuniao.data_hora|date:"d/m/Y H:i" }}</p>
                <hr style="margin: 15px 0;">
                <p><strong>Justificativa do Membro:</strong></p>
                <p style="background-color: #f0f0f0; padding: 10px; border-radius: 5px;">{{ just.texto_justificativa }}</p>

                <form action="{% url 'membros:processar' just.id %}" method="post" class="form-layout" style="margin-top: 20px;">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="feedback_analise">Feedback (opcional):</label>
                        <textarea name="feedback_analise" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" name="decisao" value="REJEITADA" class="btn-cancel" style="background-color: #e74c3c; color: white;">Rejeitar</button>
                        <button type="submit" name="decisao" value="ACEITA" class="btn-save"><i class="fa-solid fa-check"></i> Aprovar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}

{% endblock %}